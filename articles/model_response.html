<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Partial Dependence Alluvial Plots - Visualising Model Response • easyalluvial</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Partial Dependence Alluvial Plots - Visualising Model Response">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-123997499-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-123997499-2');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">easyalluvial</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/data_exploration.html">Data Exploration with Alluvial Plots</a></li>
    <li><a class="dropdown-item" href="../articles/model_response.html">Partial Dependence Alluvial Plots - Visualising Model Response</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/erblast/easyalluvial/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Partial Dependence Alluvial Plots - Visualising Model Response</h1>
                        <h4 data-toc-skip class="author">Bjönr
Koneswarakantha</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/erblast/easyalluvial/blob/master/vignettes/model_response.Rmd" class="external-link"><code>vignettes/model_response.Rmd</code></a></small>
      <div class="d-none name"><code>model_response.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/erblast/easyalluvial/" class="external-link">easyalluvial</a></span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mlbench</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">randomForest</a></span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a></span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.milbo.users.sonic.net/earth/" class="external-link">earth</a></span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://erblast.github.io/parcats/" class="external-link">parcats</a></span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>In this tutorial I want to show how you can use alluvial plots to
visualise model response in up to 4 dimensions.
<code>easyalluvial</code> generates an artificial data space using fixed
values for unplotted variables or uses the partial dependence plotting
method. It is model agnostic but offers some convenient wrappers for
<code>parsnip</code> and <code>caret</code> models. <!--more--></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="section level3">
<h3 id="taking-a-peek">Taking a peek<a class="anchor" aria-label="anchor" href="#taking-a-peek"></a>
</h3>
<p>When building machine learning models we are usually faced with a
trade-off between performance and interpretability. However there are a
lot of model agnostic interpretation techniques that can be applied even
to black box models. A good overview can be found here <a href="https://christophm.github.io/interpretable-ml-book/" class="external-link">Interpretable
Machine Learning by Christoph Molnar</a>.</p>
<p>The most intuitive interpretation techniques visualize the model
predictions in response to different data input. They try to visualise
how the model behaves in the possible data space, which is discussed
in-depth in this <a href="http://vita.had.co.nz/papers/model-vis.pdf" class="external-link">paper</a>.</p>
<p>The simplest data space only changes one input dimension, meaning
that we sequence through the range of variable while keeping all others
at a constant value. We can then plot the model predictions against the
values of the variable we have stepped through. Similarly we can create
a two dimensional data space in which we ste through the range of 2
variables. We then have to add a third dimension two the resulting
plot.</p>
</div>
<div class="section level3">
<h3 id="partial-dependence-plots">Partial Dependence Plots<a class="anchor" aria-label="anchor" href="#partial-dependence-plots"></a>
</h3>
<p>Partial Dependence Plots are a little bit more sophisticated. Instead
of setting unaffected predictor variables to a constant it uses the
values from the training data set and returns the averaged predictions
from all rows in the training data set.</p>
<p>Packages for creating partial dependence plots are: - <a href="https://cran.r-project.org/web/packages/plotmo/index.html" class="external-link"><code>plotmo</code></a>
- <a href="https://bgreenwell.github.io/pdp/index.html" class="external-link"><code>pdp</code></a></p>
</div>
<div class="section level3">
<h3 id="partial-dependence-alluvial-plots">Partial Dependence Alluvial Plots<a class="anchor" aria-label="anchor" href="#partial-dependence-alluvial-plots"></a>
</h3>
<p>Alluvial Plots can plot more than three dimensions side by side. In
practice we can plot partial dependence plots with 4 dimension. The
limitation being that we have to limit the number of flows on the plot
so we can only use 5 steps to range through the predictor variables we
want to add to the plot.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'BostonHousing'</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span> <span class="va">BostonHousing</span> <span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="st">"multisession"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html" class="external-link">rand_forest</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"regression"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"randomForest"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">parsnip</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">lstat</span> <span class="op">~</span><span class="va">.</span>, <span class="va">df</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/alluvial_model_response_parsnip.html">alluvial_model_response_parsnip</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">df</span>, degree <span class="op">=</span> <span class="fl">4</span>, bins <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                    stratum_label_size <span class="op">=</span> <span class="fl">2.8</span>,</span>
<span>                                    method <span class="op">=</span> <span class="st">"pdp"</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">p_grid</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_marginal_histograms.html">add_marginal_histograms</a></span><span class="op">(</span>data_input <span class="op">=</span> <span class="va">df</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_imp_plot.html">add_imp_plot</a></span><span class="op">(</span>p <span class="op">=</span> <span class="va">p</span>, data_input <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-2-1.png" width="1152"></p>
</div>
<div class="section level3">
<h3 id="interactive-partial-dependence-plot-with-parcats">Interactive Partial Dependence Plot with {parcats}<a class="anchor" aria-label="anchor" href="#interactive-partial-dependence-plot-with-parcats"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># parcats::parcats(p, data_input = df)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="caret-wrapper">Caret Wrapper<a class="anchor" aria-label="anchor" href="#caret-wrapper"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train</span> <span class="op">=</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/train.html" class="external-link">train</a></span><span class="op">(</span> <span class="va">lstat</span> <span class="op">~</span> <span class="va">.</span></span>
<span>                     , <span class="va">df</span></span>
<span>                     , method <span class="op">=</span> <span class="st">'rf'</span></span>
<span>                     , trControl <span class="op">=</span> <span class="fu">caret</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/caret/man/trainControl.html" class="external-link">trainControl</a></span><span class="op">(</span> method <span class="op">=</span> <span class="st">'none'</span> <span class="op">)</span></span>
<span>                     , importance <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/alluvial_model_response_caret.html">alluvial_model_response_caret</a></span><span class="op">(</span><span class="va">train</span>, <span class="va">df</span>, degree <span class="op">=</span> <span class="fl">4</span>, bins <span class="op">=</span> <span class="fl">5</span></span>
<span>                              , stratum_label_size <span class="op">=</span> <span class="fl">2.8</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="step-by-step-build-your-own-wrappers">Step By Step (build your own wrappers)<a class="anchor" aria-label="anchor" href="#step-by-step-build-your-own-wrappers"></a>
</h3>
<p>We start by creating a model</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">'BostonHousing'</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span> <span class="va">BostonHousing</span> <span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span> <span class="va">lstat</span> <span class="op">~</span> <span class="va">.</span>, <span class="va">df</span> <span class="op">)</span></span></code></pre></div>
<p>and looking at the importance features</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">imp</span> <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="va">importance</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/tidy_imp.html">tidy_imp</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="co"># </span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">imp</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">vars</th>
<th align="right">imp</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">medv</td>
<td align="right">8266.3983</td>
</tr>
<tr class="even">
<td align="left">rm</td>
<td align="right">3584.9271</td>
</tr>
<tr class="odd">
<td align="left">age</td>
<td align="right">2776.8424</td>
</tr>
<tr class="even">
<td align="left">indus</td>
<td align="right">2256.1415</td>
</tr>
<tr class="odd">
<td align="left">crim</td>
<td align="right">2174.8360</td>
</tr>
<tr class="even">
<td align="left">dis</td>
<td align="right">1984.4639</td>
</tr>
<tr class="odd">
<td align="left">nox</td>
<td align="right">1709.3720</td>
</tr>
<tr class="even">
<td align="left">b</td>
<td align="right">715.6978</td>
</tr>
<tr class="odd">
<td align="left">tax</td>
<td align="right">667.8710</td>
</tr>
<tr class="even">
<td align="left">ptratio</td>
<td align="right">467.6155</td>
</tr>
<tr class="odd">
<td align="left">rad</td>
<td align="right">237.1351</td>
</tr>
<tr class="even">
<td align="left">chas</td>
<td align="right">131.6917</td>
</tr>
<tr class="odd">
<td align="left">zn</td>
<td align="right">121.3241</td>
</tr>
</tbody>
</table>
<p>When generating the data space we cannot screen an infinite amount of
values per variable but will have to limit ourselves to a fixed number.
Then we want to create all possible combinations between these values
which determines the number of flows. The visual limit for flows on an
alluvial plot is somewhere around 1000 flows. Thus I recommend to go
with 5 values which will result in 5 x 5 X 5 X 5 –&gt; 625 combinations
and the same number of flows. That also leaves some wiggeling room if
one of the top 4 variables is a factor with more than 5 levels.
<code><a href="../reference/get_data_space.html">get_data_space()</a></code> will split the range of a variable into 3
and pick the median of each split and add the variable minimum and the
maximum to the set.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dspace</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_data_space.html">get_data_space</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">imp</span></span>
<span>                        , degree <span class="op">=</span> <span class="fl">4</span> <span class="co"># specifies the number of variables</span></span>
<span>                        , bins <span class="op">=</span> <span class="fl">5</span> <span class="co"># the number of values per variable</span></span>
<span>                        <span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dspace</span>, <span class="fl">10</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="6%">
<col width="8%">
<col width="6%">
<col width="8%">
<col width="10%">
<col width="10%">
<col width="8%">
<col width="9%">
<col width="5%">
<col width="10%">
<col width="5%">
<col width="6%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="right">medv</th>
<th align="right">rm</th>
<th align="right">age</th>
<th align="right">indus</th>
<th align="right">crim</th>
<th align="right">dis</th>
<th align="right">nox</th>
<th align="right">b</th>
<th align="right">tax</th>
<th align="right">ptratio</th>
<th align="right">rad</th>
<th align="left">chas</th>
<th align="right">zn</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">0.46</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">4.27</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">9.90</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">18.10</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">2.9</td>
<td align="right">27.74</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">0.46</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">4.27</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">9.90</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">18.10</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="right">5</td>
<td align="right">3.561</td>
<td align="right">32.2</td>
<td align="right">27.74</td>
<td align="right">0.25651</td>
<td align="right">3.20745</td>
<td align="right">0.538</td>
<td align="right">391.44</td>
<td align="right">330</td>
<td align="right">19.05</td>
<td align="right">5</td>
<td align="left">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<p>Total rows in dspace: 625</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dspace</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_all</a></span><span class="op">(</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">)</span> <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">medv</th>
<th align="right">rm</th>
<th align="right">age</th>
<th align="right">indus</th>
<th align="right">crim</th>
<th align="right">dis</th>
<th align="right">nox</th>
<th align="right">b</th>
<th align="right">tax</th>
<th align="right">ptratio</th>
<th align="right">rad</th>
<th align="right">chas</th>
<th align="right">zn</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">5</td>
<td align="right">5</td>
<td align="right">5</td>
<td align="right">5</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">1</td>
</tr></tbody>
</table>
</div>
<div class="section level3">
<h3 id="generating-model-response">Generating model response<a class="anchor" aria-label="anchor" href="#generating-model-response"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, newdata <span class="op">=</span> <span class="va">dspace</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="plotting">Plotting<a class="anchor" aria-label="anchor" href="#plotting"></a>
</h3>
<p>The predictions will be binned as well into 5 bins. Binning options
can be passed as a list via the <code>params_bin_numeric_pred</code>
parameter.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="../reference/alluvial_model_response.html">alluvial_model_response</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">dspace</span>, <span class="va">imp</span></span>
<span>                            , degree <span class="op">=</span> <span class="fl">4</span>, bins <span class="op">=</span> <span class="fl">5</span></span>
<span>                            , stratum_label_size <span class="op">=</span> <span class="fl">2.8</span> <span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="model_response_files/figure-html/alluv1-1.png" width="960"></p>
<p>We can see the binned range of predictions and explore by which
variable combination they have been created by tracing the coloured
flows. The stratum labels of the prediction variables indicate the value
of the variable and which fraction of the flows of that colour
(prediction variable bin range) pass through that stratum.</p>
</div>
<div class="section level3">
<h3 id="marginal-histograms">Marginal histograms<a class="anchor" aria-label="anchor" href="#marginal-histograms"></a>
</h3>
<p>As well as for other <code>easyalluvial</code> plots we can add
marginal histograms and as a bonus also the feature importance.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_grid</span> <span class="op">=</span> <span class="fu"><a href="../reference/add_marginal_histograms.html">add_marginal_histograms</a></span><span class="op">(</span><span class="va">p</span>, data_input <span class="op">=</span> <span class="va">df</span></span>
<span>                                 , plot <span class="op">=</span> <span class="cn">F</span> <span class="co"># plot only after adding feature importance</span></span>
<span>                                 , scale <span class="op">=</span> <span class="fl">50</span> <span class="co"># to increase distance between ridge plots, Default: 400</span></span>
<span>                                 <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_imp_plot.html">add_imp_plot</a></span><span class="op">(</span> p <span class="op">=</span> <span class="va">p</span>, data_input <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-10-1.png" width="1152"></p>
<p>We can see the original distribution of the variables, the lines
indicate the position of the values as picked by
<code><a href="../reference/get_data_space.html">get_data_space()</a></code>. When comparing the distribution of the
predictions against the original distribution of <code>lstat</code> we
see that the range of the predictions in response to the artificial
dataspace do not cover all of the range of <code>lstat</code>. Which
most likely means that all possible combinations of the 4 plotted
variables in combination with moderate values for all other predictors
will not give any extreme values. Which we can further explore, first we
will need to check whether the model is capable of making predictions in
the lower and upper ranges of <code>lsat</code>. We can use
<code><a href="../reference/plot_hist.html">plot_hist()</a></code> to only plot the distributions and add the
prediction for the training data set using the <code>pred_train</code>
parameter.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_train</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_hist.html">plot_hist</a></span><span class="op">(</span><span class="st">'pred'</span>, <span class="va">p</span>, <span class="va">df</span></span>
<span>          , pred_train <span class="op">=</span> <span class="va">pred_train</span> <span class="co"># pred_train can also be passed to add_marginal_histograms()</span></span>
<span>          , scale <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-11-1.png" width="288" style="display: block; margin: auto;"></p>
<p>We see that the training prediction also do not completely cover all
of the <code>lstat</code> range but more of it than the predictions from
the artificial data space.</p>
<p>If we wanted to emphasize this we can bin the data space predictions
on the basis of the training predictions. In this case it makes sense to
increase the number of bins for the predictions in order not to loose
resolution on the plot.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="../reference/alluvial_model_response.html">alluvial_model_response</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">dspace</span>, <span class="va">imp</span>, degree <span class="op">=</span> <span class="fl">4</span></span>
<span>                            , bin_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LLL"</span>,<span class="st">"LL"</span>, <span class="st">"ML"</span>, <span class="st">"M"</span>, <span class="st">"MH"</span>, <span class="st">"HH"</span>, <span class="st">"HHH"</span><span class="op">)</span></span>
<span>                            , params_bin_numeric_pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span>                            , pred_train <span class="op">=</span> <span class="va">pred_train</span></span>
<span>                            , stratum_label_size <span class="op">=</span> <span class="fl">2.8</span> <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in .f(.x[[i]], ...): bins (25.2,32.7] of pred are empty</span></span></code></pre>
<pre><code><span><span class="co">## Warning in alluvial_model_response(pred, dspace, imp, degree = 4, bin_labels =</span></span>
<span><span class="co">## c("LLL", : binned predictions have only 6 bins, which is less bins than</span></span>
<span><span class="co">## 'bin_labels'</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_hist.html">plot_hist</a></span><span class="op">(</span><span class="st">'pred'</span>, <span class="va">p</span>, <span class="va">df</span>, scale <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_response_files/figure-html/p_hist-1.png" width="288" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_grid</span> <span class="op">=</span> <span class="fu"><a href="../reference/add_marginal_histograms.html">add_marginal_histograms</a></span><span class="op">(</span><span class="va">p</span>, data_input <span class="op">=</span> <span class="va">df</span></span>
<span>                                 , plot <span class="op">=</span> <span class="cn">F</span> <span class="co"># plot only after adding feature importance</span></span>
<span>                                 , scale <span class="op">=</span> <span class="fl">50</span> <span class="co"># to increase distance between ridge plots, Default: 400</span></span>
<span>                                 <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_imp_plot.html">add_imp_plot</a></span><span class="op">(</span> p <span class="op">=</span> <span class="va">p</span>, data_input <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-12-1.png" width="1152"></p>
</div>
</div>
<div class="section level2">
<h2 id="what-feature-combinations-are-needed-to-obtain-predictions-in-the-lower-and-higher-ranges-of-lstat">What feature combinations are needed to obtain predictions in the
lower and higher ranges of <code>lstat</code>?<a class="anchor" aria-label="anchor" href="#what-feature-combinations-are-needed-to-obtain-predictions-in-the-lower-and-higher-ranges-of-lstat"></a>
</h2>
<p>We can add the training predictions to the training data and assign
the variables not covered by the model response plot to bins. We can
then create an alluvial plot over the entire training dataframe in order
to trace the <code>lstat</code> ranges not covered by the model response
alluvial plot above. Since we are only interested in those observations
we remove all other flows from the plot by setting their color to
<code>NA</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">breaks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">pred_train</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pred_train</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">df_inv</span> <span class="op">=</span> <span class="va">df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">lstat</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> pred_train <span class="op">=</span> <span class="va">pred_train</span></span>
<span>          , pred_train <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">pred_train</span>, <span class="va">breaks</span><span class="op">)</span> <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span> <span class="va">pred_train</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/one_of.html" class="external-link">one_of</a></span><span class="op">(</span><span class="va">imp</span><span class="op">$</span><span class="va">vars</span><span class="op">)</span> <span class="op">)</span> <span class="co"># order by feature importance</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="../reference/alluvial_wide.html">alluvial_wide</a></span><span class="op">(</span><span class="va">df_inv</span>, bin_labels <span class="op">=</span> <span class="st">'min_max'</span></span>
<span>                  , stratum_label_size <span class="op">=</span> <span class="fl">3</span></span>
<span>                  , col_vector_flow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'blue'</span>, <span class="cn">NA</span>, <span class="st">'orange'</span><span class="op">)</span></span>
<span>                  , colorful_fill_variable_stratum <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in .f(.x[[i]], ...): bins (-0.668,-0.379],(-0.379,-0.0886] of zn are</span></span>
<span><span class="co">## empty</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_grid</span> <span class="op">=</span> <span class="fu"><a href="../reference/add_marginal_histograms.html">add_marginal_histograms</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">df_inv</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-13-1.png" width="1152"></p>
<p>We can see that for the upper ranges of <code>lstat</code> a pretty
specific combination values is required from 8 feature variables from
<code>medv</code> until <code>tax</code> only then begin the flows to
scatter over the entire range of the following variables. The lower
range values of <code>lstat</code> start to scatter at <code>crim</code>
or <code>dis</code>. Interestingly there seems to be a set of houses
that branches off from the other houses in the lower range of
<code>lstat</code> predictions already at the third feature,
<code>age</code>. We could potentially explore this further, as a
reminder you can get the binned input data for each alluvial plot by
calling <code>attr(p, "data_key")</code> and trace the variables of
interest.</p>
</div>
<div class="section level2">
<h2 id="advantages">Advantages<a class="anchor" aria-label="anchor" href="#advantages"></a>
</h2>
<p>Model response alluvial plots can help us to get an immediate
intuitive understanding how predictions of a certain range can be
generated by the model. They can be understood by none-statistical
stakeholders and invite the viewer to start exploring and question the
decision making process of the model while also conveying an
appreciation for the model complexity as flows branch out to the
variables of lower feature importance.</p>
<div class="section level3">
<h3 id="none-regression-models">None-regression models<a class="anchor" aria-label="anchor" href="#none-regression-models"></a>
</h3>
<p>Works the same way.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mtcars2</span>, <span class="op">-</span><span class="va">ids</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu">randomForest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span> <span class="va">am</span> <span class="op">~</span> <span class="va">.</span>, <span class="va">df</span><span class="op">)</span></span>
<span><span class="va">imp</span> <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="va">importance</span></span>
<span><span class="va">dspace</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_data_space.html">get_data_space</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">imp</span>, degree <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, newdata <span class="op">=</span> <span class="va">dspace</span>,type <span class="op">=</span> <span class="st">'response'</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="../reference/alluvial_model_response.html">alluvial_model_response</a></span><span class="op">(</span><span class="va">pred</span>, <span class="va">dspace</span>, <span class="va">imp</span>, degree <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="model_response_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h3>
<ul>
<li>There is a loss of information when binning the numerical
variables</li>
<li>The combinations generated when making the grid might be outside the
feature distribution space (generate combinations that are
impossible)</li>
<li>We only look at the combination of 4 features and disregard the
others</li>
</ul>
<p>To alleviate this you can reduce the complexity of the model by
reducing features (take out correlating variables) or use additional
model exploration methods such as classical PDPs, ALE plots, Shapely
values, etc, …</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bjoern Koneswarakantha.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
